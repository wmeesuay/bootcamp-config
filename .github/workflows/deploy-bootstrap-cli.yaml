---
name: deploy-bootstrap-cli

on:
    push:
        branches:
            - main

jobs:
    bootstrap_cdf:
        name: Bootstrap CDF
        runs-on: ubuntu-latest
        strategy:
            matrix:
                environment: [test, prod]
                include:
                    - environment: test
                      # CDF cluster, like bluefield or greenfield
                      CDF_CLUSTER: [CDF_CLUSTER]
                      # CDF Project name
                      CDF_PROJECT:  [CDF_PROJECT]
                      # Azure AD tenant id
                      IDP_TENANT:  [AAD_TENANT_ID]
                      SECRET: [CLIENT_SECRET_TEST]
                      CLIENT_ID: [CLIENT_ID_TEST]
                    - environment: prod
                      # CDF cluster, like bluefield or greenfield
                      CDF_CLUSTER: [CDF_CLUSTER]
                      # CDF Project name
                      CDF_PROJECT:  [CDF_PROJECT]
                      # Azure AD tenant id
                      IDP_TENANT:  [AAD_TENANT_ID]
                      SECRET: [CLIENT_SECRET_PROD]
                      CLIENT_ID: [CLIENT_ID_PROD]

        environment: ${{ matrix.environment}}
        env:
            CDF_HOST: https://${{ matrix.CDF_CLUSTER }}.cognitedata.com/

        steps:
            - name: test
              run: echo ${{ secrets.CLIENT_ID_ADMIN_TEST }}
            - uses: actions/checkout@v3
            - uses: cognitedata/inso-bootstrap-cli@main
              env:
                  BOOTSTRAP_IDP_CLIENT_ID: ${{ secrets[matrix.CLIENT_ID] }}
                  BOOTSTRAP_CDF_HOST: ${{ env.CDF_HOST }}
                  BOOTSTRAP_CDF_PROJECT: ${{ matrix.CDF_PROJECT }}
                  BOOTSTRAP_IDP_CLIENT_SECRET: ${{ secrets[matrix.SECRET] }}
                  BOOTSTRAP_IDP_TOKEN_URL: https://login.microsoftonline.com/${{ matrix.IDP_TENANT }}/oauth2/v2.0/token
                  BOOTSTRAP_IDP_SCOPES: ${{ env.CDF_HOST }}.default

              with:
                  # Path to Bootstrap CLI configuration file
                  config_file: ./config/bootstrap/bootstrap-cli-config.yml
            # "yes"|"no" deploy with special groups and aad_mappings
            #with_special_groups: "yes"
